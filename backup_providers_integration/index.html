<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Backup Providers Integration | Documentation</title>
    <meta name="description" content="Kernelcare documentation">
    
    
    <link rel="preload" href="/assets/css/0.styles.5ccae1ef.css" as="style"><link rel="preload" href="/assets/js/app.82cee872.js" as="script"><link rel="preload" href="/assets/js/5.3d4a6f6f.js" as="script"><link rel="prefetch" href="/assets/js/10.b51fe28b.js"><link rel="prefetch" href="/assets/js/11.e6dc8b34.js"><link rel="prefetch" href="/assets/js/12.4bcb335d.js"><link rel="prefetch" href="/assets/js/13.d0200ffb.js"><link rel="prefetch" href="/assets/js/14.555a9df0.js"><link rel="prefetch" href="/assets/js/15.e307524e.js"><link rel="prefetch" href="/assets/js/16.1cca512c.js"><link rel="prefetch" href="/assets/js/17.a68b8f5e.js"><link rel="prefetch" href="/assets/js/18.3419b333.js"><link rel="prefetch" href="/assets/js/19.233ab1aa.js"><link rel="prefetch" href="/assets/js/20.2c54de63.js"><link rel="prefetch" href="/assets/js/3.4eb84044.js"><link rel="prefetch" href="/assets/js/4.b81ccb47.js"><link rel="prefetch" href="/assets/js/6.3a9c5751.js"><link rel="prefetch" href="/assets/js/7.b3aaff77.js"><link rel="prefetch" href="/assets/js/8.6619a899.js"><link rel="prefetch" href="/assets/js/9.48f2c7f5.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.28e1d2e5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5ccae1ef.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.svg" alt="Documentation" class="logo"> <span class="site-name can-hide">Documentation</span></a> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value="Search"> <!----></div> <div class="links" style="max-width:nullpx;"><a href="https://www.imunify360.com/trial" target="_blank" class="btn">
      Try Free
    </a> <nav class="nav-links can-hide"></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Content</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/introduction/" class="sidebar-link">Introduction</a></li><li><a href="/terminology/" class="sidebar-link">Terminology</a></li><li><a href="/billing/" class="sidebar-link">Billing</a></li><li><a href="/installation/" class="sidebar-link">Installation Guide</a></li><li><a href="/ids_integration/" class="sidebar-link">IDS Integrations</a></li><li><a href="/backup_providers_integration/" class="active sidebar-link">Backup Providers Integration</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backup_providers_integration/#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/backup_providers_integration/#command-line-usage" class="sidebar-link">Command Line Usage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backup_providers_integration/#synopsis" class="sidebar-link">Synopsis</a></li><li class="sidebar-sub-header"><a href="/backup_providers_integration/#actions" class="sidebar-link">Actions</a></li></ul></li><li class="sidebar-sub-header"><a href="/backup_providers_integration/#using-as-library" class="sidebar-link">Using as Library</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backup_providers_integration/#restoring-infected-files" class="sidebar-link">Restoring Infected Files</a></li><li class="sidebar-sub-header"><a href="/backup_providers_integration/#operating-with-backend" class="sidebar-link">Operating With Backend</a></li><li class="sidebar-sub-header"><a href="/backup_providers_integration/#operating-with-backup" class="sidebar-link">Operating With Backup</a></li><li class="sidebar-sub-header"><a href="/backup_providers_integration/#operating-with-file-in-backup" class="sidebar-link">Operating With File in Backup</a></li></ul></li><li class="sidebar-sub-header"><a href="/backup_providers_integration/#creating-custom-backup-backend-plugin" class="sidebar-link">Creating Custom Backup Backend Plugin</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backup_providers_integration/#creating-module" class="sidebar-link">Creating Module</a></li><li class="sidebar-sub-header"><a href="/backup_providers_integration/#defining-classes" class="sidebar-link">Defining Classes</a></li><li class="sidebar-sub-header"><a href="/backup_providers_integration/#implementing-api-functions" class="sidebar-link">Implementing API Functions</a></li></ul></li></ul></li><li><a href="/localization/" class="sidebar-link">Localization</a></li><li><a href="/captcha/" class="sidebar-link">Captcha</a></li><li><a href="/dashboard/" class="sidebar-link">Imunify360 User Interface</a></li><li><a href="/hosting_panels_specific_settin/" class="sidebar-link">Hosting Panels Firewall Rulsets Specific Settings</a></li><li><a href="/config_file_description/" class="sidebar-link">Config File Description</a></li><li><a href="/command_line_interface/" class="sidebar-link">Command-line Interface</a></li><li><a href="/uninstall/" class="sidebar-link">Uninstall</a></li><li><a href="/faq_and_known_issues/" class="sidebar-link">FAQ and Known Issues</a></li><li><a href="/whmcs_plugin/" class="sidebar-link">Imunify360 WHMCS Plugin</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="backup-providers-integration"><a href="#backup-providers-integration" aria-hidden="true" class="header-anchor">#</a> Backup Providers Integration</h1> <p></p><div class="table-of-contents"><ul><li><a href="#overview">Overview</a></li><li><a href="#command-line-usage">Command Line Usage</a><ul><li><a href="#synopsis">Synopsis</a></li><li><a href="#actions">Actions</a></li></ul></li><li><a href="#using-as-library">Using as Library</a><ul><li><a href="#restoring-infected-files">Restoring Infected Files</a></li><li><a href="#operating-with-backend">Operating With Backend</a></li><li><a href="#operating-with-backup">Operating With Backup</a></li><li><a href="#operating-with-file-in-backup">Operating With File in Backup</a></li></ul></li><li><a href="#creating-custom-backup-backend-plugin">Creating Custom Backup Backend Plugin</a><ul><li><a href="#creating-module">Creating Module</a></li><li><a href="#defining-classes">Defining Classes</a></li><li><a href="#implementing-api-functions">Implementing API Functions</a></li></ul></li></ul></div><p></p> <h2 id="overview"><a href="#overview" aria-hidden="true" class="header-anchor">#</a> Overview</h2> <p><strong>Restore_infected</strong> is a library written in Python 3. It allows to restore files from backups. It supports several backup backends. Each backend is represented as a plugin which uses a particular API to the backup server and provides a user with a common interface to restore individual files regardless of backup backend selected. In addition to the existing backends custom ones can be added.</p> <p>If one of the files is infected with malware the library can also search for the last uninfected revision of this file in available backups and restore it. By default it uses <em>imunify360-agent</em> to detect infected files but a custom algorithm can be used instead.</p> <p><img src="/images/restoreinfectedscheme_zoom70.png" alt></p> <p>From the figure above can see that the user of the library is supposed to reference it either using command line interface or calling library functions directly. The CLI supports interaction with the <em>restore algorithm</em> but not with the backend API. <em>Restore algorithm</em> doesn’t have a functionality to restore a file from any backup but is capable of restoring files infected with malware instead. It treats absent files as infected ones therefore restores the last revision of those.</p> <h2 id="command-line-usage"><a href="#command-line-usage" aria-hidden="true" class="header-anchor">#</a> Command Line Usage</h2> <p>A command line interface to <strong>restore_infected</strong> library is present in the file <strong>restore_infected_cli.py</strong>. If installed from the RPM, the binary is located in <em>/usr/bin/restore_infected</em> and can be used as <em>“restore_infected”</em> . To use the CLI a backend and an action should be specified.</p> <p>The library includes the following backup backend plugins:</p> <ul><li>Acronis</li> <li>cPanel</li> <li>Plesk</li></ul> <h3 id="synopsis"><a href="#synopsis" aria-hidden="true" class="header-anchor">#</a> Synopsis</h3> <div class="language- extra-class"><pre class="language-text"><code>restore_infected BACKEND ACTION
</code></pre></div><p>Where <code>BACKEND</code> is one of the backends - predefined or custom and <code>ACTION</code> is one of the actions described below.</p> <h3 id="actions"><a href="#actions" aria-hidden="true" class="header-anchor">#</a> Actions</h3> <h4 id="init"><a href="#init" aria-hidden="true" class="header-anchor">#</a> init</h4> <p>The first step most of the plugins will need is initialization. The most common use of it is to save credentials for the backup server.</p> <div class="language- extra-class"><pre class="language-text"><code>init arg0 arg1 ...
</code></pre></div><p>The arguments may vary depending on the backend used. To see which arguments are needed for the particular plugin you can call <code>init</code> with no arguments:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code>restore_infected acronis init
usage<span class="token punctuation">:</span> restore_infected <span class="token punctuation">[</span><span class="token operator">-</span>h<span class="token punctuation">]</span> BACKEND <span class="token punctuation">{</span>init<span class="token punctuation">,</span><span class="token builtin">list</span><span class="token punctuation">,</span>restore<span class="token punctuation">,</span>cleanup<span class="token punctuation">}</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
restore_infected<span class="token punctuation">:</span> error<span class="token punctuation">:</span> init arguments required<span class="token punctuation">:</span> username password
</code></pre></div><p>To install Acronis backup agent, pass <code>--provision</code> option to <code>init</code> command. To force installation when agent is present use <code>--force</code> option.</p> <h4 id="list"><a href="#list" aria-hidden="true" class="header-anchor">#</a> list</h4> <p>list shows available backups sorted by date starting with the newest.</p> <div class="language- extra-class"><pre class="language-text"><code>list [--until]
</code></pre></div><p>If a date string is passed as <code>--until</code>, list all backups from now up to that date or all backups otherwise. The date for <code>--unitil</code> parameter can be in any format that python-dateutil can parse, e.g. <em>2017-08-01</em>, <em>01 Aug 2017</em>, etc.</p> <p>Example:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code>restore_infected acronis <span class="token builtin">list</span> <span class="token operator">-</span><span class="token operator">-</span>until <span class="token string">&quot;01 Aug 2017&quot;</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span>06T10<span class="token punctuation">:</span><span class="token number">22</span><span class="token punctuation">:</span><span class="token number">00</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span>05T06<span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span>03T12<span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token number">00</span>
</code></pre></div><h4 id="restore"><a href="#restore" aria-hidden="true" class="header-anchor">#</a> restore</h4> <div class="language- extra-class"><pre class="language-text"><code>restore files [--until]
</code></pre></div><p>Restore files from backup. <code>restore</code> takes a list of files (paths to them) which are considered infected, searches for the first uninfected entry of each file in backups and restores it. Backups older than the date set in <code>--until</code> are not considered.</p> <p>Example:</p> <div class="language- extra-class"><pre class="language-text"><code>restore_infected acronis restore &quot;/root/file1&quot; &quot;/root/file2&quot; --until &quot;01 Aug 2017&quot;
</code></pre></div><h4 id="cleanup"><a href="#cleanup" aria-hidden="true" class="header-anchor">#</a> cleanup</h4> <p>The most common use is to delete any temporary files created by the plugin. Depending on the backend the functionality may vary or such function might not be present at all.</p> <p>Example:</p> <div class="language- extra-class"><pre class="language-text"><code>restore_infected plesk cleanup
</code></pre></div><p><strong>extra</strong></p> <p>This is for acrivity not connected to restoring from backups.</p> <p>Currently supported options are</p> <ul><li><code>login_url</code> (for Acronis backend). This option returns url to log in to Acronis cloud web interface.</li> <li><code>refresh_token</code> (for Acronis backend). This option refreshes authentication token to keep it valid.</li></ul> <h2 id="using-as-library"><a href="#using-as-library" aria-hidden="true" class="header-anchor">#</a> Using as Library</h2> <h3 id="restoring-infected-files"><a href="#restoring-infected-files" aria-hidden="true" class="header-anchor">#</a> Restoring Infected Files</h3> <p>The main purpose of the library is to search for uninfected files and to restore them as a replacement for infected ones. The function responsible for that is located in a module <code>restore_infected.restore</code>:</p> <div class="language- extra-class"><pre class="language-text"><code>restore_infected(backend, files, until=None, scan_func=scan)
</code></pre></div><p>Where:</p> <ul><li><code>backend</code> is a backend plugin module;</li> <li><code>files</code> is a list of files to scan and restore;</li> <li><code>until</code> filters the backups before specified date;</li> <li><code>scan_func</code> is a function that scans files for malware. It takes a list of files and returns the list of infected ones, by default it uses the function <code>scan</code> from the same module.</li></ul> <p>For example <code>restore_infected</code> can be called like this:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code><span class="token keyword">from</span> restore_infected <span class="token keyword">import</span> backup_backends
<span class="token keyword">from</span> restore_infected<span class="token punctuation">.</span>restore <span class="token keyword">import</span> restore_infected
<span class="token keyword">from</span> restore_infected<span class="token punctuation">.</span>helpers <span class="token keyword">import</span> DateTime
 
plesk <span class="token operator">=</span> backup_backends<span class="token punctuation">.</span>backend<span class="token punctuation">(</span><span class="token string">'plesk'</span><span class="token punctuation">)</span>
 
<span class="token keyword">def</span> <span class="token function">my_scan</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">:</span>
  infected <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment"># scan files here</span>
  <span class="token keyword">return</span> infected
 
restore_infected<span class="token punctuation">(</span>
plesk<span class="token punctuation">,</span>
<span class="token string">&quot;/var/www/vhosts/u1.pl7.cloudlinux.com/httpdocs/index.php&quot;</span><span class="token punctuation">,</span>
until<span class="token operator">=</span>DateTime<span class="token punctuation">(</span><span class="token string">&quot;9 Aug 2017&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
scan_func<span class="token operator">=</span>my_scan<span class="token punctuation">)</span>
</code></pre></div><h3 id="operating-with-backend"><a href="#operating-with-backend" aria-hidden="true" class="header-anchor">#</a> Operating With Backend</h3> <p>A backend plugin can be imported directly from <code>restore_infected.backup_backends</code>. Every plugin has a function called <code>backups</code> which returns the list of objects each of which is representing a backup, and might have optional functions <code>init</code> and/or <code>cleanup</code> which initialize and cleanup the plugin respectively.</p> <p>In the following example let’s print out all backups. For <code>plesk</code> in the following example the <code>init</code> function is not needed so we can call backups right away:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code><span class="token keyword">from</span> restore_infected <span class="token keyword">import</span> backup_backends
plesk <span class="token operator">=</span> backup_backends<span class="token punctuation">.</span>backend<span class="token punctuation">(</span><span class="token string">'plesk'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> backup <span class="token keyword">in</span> plesk<span class="token punctuation">.</span>backups<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token keyword">print</span><span class="token punctuation">(</span>backup<span class="token punctuation">)</span>
</code></pre></div><p>This will give us the following list of backups:</p> <div class="language- extra-class"><pre class="language-text"><code>/var/lib/psa/dumps/clients/u3/domains/u3.pl7.cloudlinux.com/backup_info_1708080701_1708090501.xml
/var/lib/psa/dumps/clients/u1/domains/u1.pl7.cloudlinux.com/backup_info_1708090500.xml
&lt;...&gt;
/var/lib/psa/dumps/clients/u1/domains/u1.pl7.cloudlinux.com/backup_info_1707070347_1707070353.xml
/var/lib/psa/dumps/clients/u1/domains/u1.pl7.cloudlinux.com/backup_info_1707070347.xml
</code></pre></div><p><code>backups</code> has an optional parameter <code>until</code> of <code>restore_infected.helpers.DateTime</code>. To filter out backups from 9 Aug 2017 till now the code can be changed like this:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code><span class="token keyword">from</span> restore_infected <span class="token keyword">import</span> backup_backends
plesk <span class="token operator">=</span> backup_backends<span class="token punctuation">.</span>backend<span class="token punctuation">(</span><span class="token string">'plesk'</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> restore_infected<span class="token punctuation">.</span>helpers <span class="token keyword">import</span> DateTime
<span class="token keyword">for</span> backup <span class="token keyword">in</span> plesk<span class="token punctuation">.</span>backups<span class="token punctuation">(</span>DateTime<span class="token punctuation">(</span><span class="token string">&quot;9 Aug 2017&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
       <span class="token keyword">print</span><span class="token punctuation">(</span>backup<span class="token punctuation">)</span>
</code></pre></div><h3 id="operating-with-backup"><a href="#operating-with-backup" aria-hidden="true" class="header-anchor">#</a> Operating With Backup</h3> <p>In the previous step we printed out some backups. Every backup entry regardless of the plugin also has a field <code>created</code> which tells when the actual backup was created. It makes backups comparable.</p> <p>Example:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code>backups <span class="token operator">=</span> plesk<span class="token punctuation">.</span>backups<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>backups<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>created<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>backups<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>created<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>backups<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> backups<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
Which gives us<span class="token punctuation">:</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">01</span><span class="token punctuation">:</span><span class="token number">00</span>
<span class="token number">2017</span><span class="token operator">-</span><span class="token number">08</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">07</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span>
<span class="token boolean">True</span>
</code></pre></div><p></p> <h3 id="operating-with-file-in-backup"><a href="#operating-with-file-in-backup" aria-hidden="true" class="header-anchor">#</a> Operating With File in Backup</h3> <p>A method <code>file_data</code> returns a representation of a file in this backup as an instance of a class (hereafter, this class is referenced to <code>FileData</code>):</p> <div class="language- extra-class"><pre class="language-text"><code>print(backup.file_data('/var/www/vhosts/u1.pl7.cloudlinux.com/httpdocs/index.php'))
</code></pre></div><p>Output:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code><span class="token operator">&lt;</span>FileData<span class="token punctuation">(</span>
fileobj<span class="token operator">=</span><span class="token operator">&lt;</span>ExFileObject name<span class="token operator">=</span><span class="token string">'/var/lib/psa/dumps/clients/u1/domains/u1.pl7.cloudlinux.com/backup_user-data_1708080700.tgz'</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
filename<span class="token operator">=</span><span class="token string">'/var/www/vhosts/u1.pl7.cloudlinux.com/httpdocs/index.php'</span><span class="token punctuation">,</span>
size<span class="token operator">=</span><span class="token number">418</span><span class="token punctuation">,</span>
mtime<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">(</span><span class="token number">2013</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span>
<span class="token operator">&gt;</span> 
</code></pre></div><p>where <code>mtime</code> is the time of the last modification of a file.</p> <p>Besides these fields, FileData also has a method <code>restore</code>. If <code>destination</code> is passed as a parameter then the file is restored and saved in specified folder saving the directory hierarchy. The default <code>destination</code> is <code>/</code> which means that the file is restored to the place of its origin.</p> <p>Example:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code><span class="token keyword">from</span> restore_infected <span class="token keyword">import</span> backup_backends
plesk <span class="token operator">=</span> backup_backends<span class="token punctuation">.</span>backend<span class="token punctuation">(</span><span class="token string">'plesk'</span><span class="token punctuation">)</span>
backups <span class="token operator">=</span> plesk<span class="token punctuation">.</span>backups<span class="token punctuation">(</span><span class="token punctuation">)</span>
filedata <span class="token operator">=</span> \
backups<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>file_data<span class="token punctuation">(</span><span class="token string">'/var/www/vhosts/u1.pl7.cloudlinux.com/httpdocs/index.php'</span><span class="token punctuation">)</span>
filedata<span class="token punctuation">.</span>restore<span class="token punctuation">(</span><span class="token string">'/home/user/restored_files'</span><span class="token punctuation">)</span>
</code></pre></div><p>It gives no output if zero errors occurred and creates <code>'var/...'</code> directories in <code>'/home/user/restored_files'</code> with a restored file.</p> <p>From now on Acronis backend supports <code>provision=True/False</code> (by default <code>False</code>) and <code>force=True/False</code> (by default <code>False</code>) options for <code>init</code> action, to install Acronis backend agent. Use <code>force</code> to reinstall agent if it is already present.</p> <p>As of version 1.2-1, Acronis <code>init</code> takes optional argument <code>tmp_dir</code> to specify temporal directory for installing Acronis backup client.</p> <p>Example:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code><span class="token keyword">from</span> restore_infected <span class="token keyword">import</span> backup_backends
acronis <span class="token operator">=</span> backup_backends<span class="token punctuation">.</span>backend<span class="token punctuation">(</span><span class="token string">'acronis'</span><span class="token punctuation">)</span>
acronis<span class="token punctuation">.</span>init<span class="token punctuation">(</span>name<span class="token punctuation">,</span> password<span class="token punctuation">,</span> provision<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> force<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> tmp_dir<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><p><code>login_url</code> action for return URL to log in to Acronis web interface.</p> <p>Example:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code><span class="token keyword">from</span> restore_infected <span class="token keyword">import</span> backup_backends
 acronis <span class="token operator">=</span> backup_backends<span class="token punctuation">.</span>backend<span class="token punctuation">(</span><span class="token string">'acronis'</span><span class="token punctuation">)</span>
 token <span class="token operator">=</span> acronis<span class="token punctuation">.</span>login_url<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p><code>login_url</code> action for refreshing authentication token.</p> <p>Example:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code> <span class="token keyword">from</span> restore_infected <span class="token keyword">import</span> backup_backends
  acronis <span class="token operator">=</span> backup_backends<span class="token punctuation">.</span>backend<span class="token punctuation">(</span><span class="token string">'acronis'</span><span class="token punctuation">)</span>
 acronis<span class="token punctuation">.</span>refresh_token<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p><code>info</code> action to return region, schedule and used storage space in JSON format.</p> <p>Example:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code> <span class="token keyword">from</span> restore_infected <span class="token keyword">import</span> backup_backends
 acronis <span class="token operator">=</span> backup_backends<span class="token punctuation">.</span>backend<span class="token punctuation">(</span><span class="token string">'acronis'</span><span class="token punctuation">)</span>
 info <span class="token operator">=</span> acronis<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">{</span><span class="token string">'schedule'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'usage'</span><span class="token punctuation">:</span> <span class="token number">17890969600</span><span class="token punctuation">,</span> <span class="token string">'region'</span><span class="token punctuation">:</span> <span class="token string">'eu2'</span><span class="token punctuation">}</span>
</code></pre></div></li> <li><p><code>make_initial_backup</code> makes initial backup after Acronis backup client is installed. By default it does not wait for the backup completion. To wait for the backup to be completed use option <code>trace=True</code> . When such an option is on, current completion percentage is being outputted to log file (by default <em>/var/restore_infected/acronis_backup.log</em>. Returns <code>True</code> if backup is successful and <code>False</code> otherwise.</p> <p>Example:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code> <span class="token keyword">from</span> restore_infected <span class="token keyword">import</span> backup_backends
 acronis <span class="token operator">=</span> backup_backends<span class="token punctuation">.</span>backend<span class="token punctuation">(</span><span class="token string">'acronis'</span><span class="token punctuation">)</span>
 acronis<span class="token punctuation">.</span>make_initial_backup<span class="token punctuation">(</span>trace<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</code></pre></div></li></ul> <h2 id="creating-custom-backup-backend-plugin"><a href="#creating-custom-backup-backend-plugin" aria-hidden="true" class="header-anchor">#</a> Creating Custom Backup Backend Plugin</h2> <h3 id="creating-module"><a href="#creating-module" aria-hidden="true" class="header-anchor">#</a> Creating Module</h3> <p>To create a plugin for a particular backup backend a python module should be created in <code>backup_backends</code> folder. The plugin will be registered automatically when a function <code>backend(name)</code> from <code>backup_backends</code> module is called.
If the plugin should be used only in some appropriate systems environment <code>is_suitable</code> function could be implemented, which should return Boolean. It will be called during <code>backend(name)</code> from <code>backup_backends</code> function call and if <code>is_suitable False</code>, then <code>BackendNonApplicableError</code> exception will be raised.</p> <p>Here is an example of <code>is_suitable</code> function for DirectAdmin module:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">is_suitable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token keyword">return</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span><span class="token string">'/usr/local/directadmin/directadmin'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="defining-classes"><a href="#defining-classes" aria-hidden="true" class="header-anchor">#</a> Defining Classes</h3> <p>There are two mandatory classes that have to be implemented in the plugin.</p> <h4 id="backup-class"><a href="#backup-class" aria-hidden="true" class="header-anchor">#</a> Backup Class</h4> <p>This class represents a backup. It can have any name since it is not directly referenced to from the outside of the module. It can either be inherited from</p> <div class="language- extra-class"><pre class="language-text"><code>backup_backends_lib.BackupBase
</code></pre></div><p>which already have some features (e.g. comparison) implemented or it can be written from scratch. The class must define a method <code>file_data</code> that returns a FileData object (described below). Objects of this class should also be comparable by the date created as if they were actual backups.</p> <h4 id="filedata-class"><a href="#filedata-class" aria-hidden="true" class="header-anchor">#</a> FileData Class</h4> <p>The second class that has to be implemented is <em>FileData</em> which represents a file in a backup. It must have file size, modify time and a method <code>restore</code>.</p> <h3 id="implementing-api-functions"><a href="#implementing-api-functions" aria-hidden="true" class="header-anchor">#</a> Implementing API Functions</h3> <p>There are 3 functions in the plugin, but only one of them is mandatory - <code>backups</code>. This function returns a list of Backup instances. Optional functions are <code>init</code>, <code>cleanup</code>, and <code>info</code> that are responsible for the initialization, cleanup and getting some information of the plugin respectively.</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">def</span> <span class="token function">backups</span><span class="token punctuation">(</span>until<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">def</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   …
<span class="token keyword">def</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
</code></pre></div><p>Depending on the features of the backend being integrated, the plugin might have one or more classes and functions responsible to authorise on the backup server and retrieve data from it, however only functions <code>init</code>, <code>backups</code>, <code>cleanup</code>, and <code>info</code> are called from the outside of the module.</p> <p>To check that the plugin works as intended try passing your plugin name to the CLI for example like this:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code>restore_infected <span class="token operator">&lt;</span>your_backend_name<span class="token operator">&gt;</span> <span class="token builtin">list</span>
</code></pre></div><p>To be used in asynchronous libraries <code>async_restore_infected</code> routine has been added. Typical use case:</p> <div class="language-Python 3 extra-class"><pre class="language-python"><code><span class="token keyword">import</span> logging
<span class="token keyword">from</span> restore_infected <span class="token keyword">import</span> backup_backends
<span class="token keyword">from</span> restore_infected<span class="token punctuation">.</span>restore <span class="token keyword">import</span> async_restore_infected
<span class="token keyword">from</span> defence360agent<span class="token punctuation">.</span>malscan<span class="token punctuation">.</span>scanner <span class="token keyword">import</span> MalwareScanner
 
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_custom_scan_function</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token operator">not</span> files<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    still_infected <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    scanner <span class="token operator">=</span> MalwareScanner<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scan_filelist<span class="token punctuation">(</span><span class="token punctuation">)</span>
    scanner<span class="token punctuation">.</span>start<span class="token punctuation">(</span>files<span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> scanner<span class="token punctuation">.</span>async_wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> result<span class="token punctuation">[</span><span class="token string">'results'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        still_infected <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token string">'results'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> still_infected
 
<span class="token keyword">class</span> <span class="token class-name">DummyDumper</span><span class="token punctuation">:</span>
    @<span class="token builtin">classmethod</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">do_restore</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> files<span class="token punctuation">)</span><span class="token punctuation">:</span>
        backend <span class="token operator">=</span> backup_backends<span class="token punctuation">.</span>backend<span class="token punctuation">(</span><span class="token string">'cpanel'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> async_restore_infected<span class="token punctuation">(</span>
            backend<span class="token punctuation">,</span> files<span class="token punctuation">,</span> scan_func<span class="token operator">=</span>_custom_scan_function
</code></pre></div><p>For Acronis backup two restore modes are available:</p> <ul><li><strong>Download mode</strong> – a file to be restored is simply pulled by HTTP from backup server</li> <li><strong>Recovery mode</strong>  – <code>restore_infected</code> just sends command to backup server and then waits for the file to be restored is actually placed to expected folder. Its size is equal to expected one.</li></ul> <p>Recovery mode is used by default because it restores file owner and permissions, too. Though downloading mode can be enabled with passing <code>use_download</code> option to <code>restore_infected</code> function. The second optional parameter - <code>timeout</code> can be passed to <code>restore_infected</code> function to change the default waiting time (time to wait while a file to be restored is being pulled by recovery agent). By default timeout is 600 seconds.</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/cloudlinux/imunify360-doc/edit/dev/docs/backup_providers_integration/README.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/ids_integration/" class="prev">
          IDS Integrations
        </a></span> <span class="next"><a href="/localization/">
          Localization
        </a>
        →
      </span></p></div> </div> <div class="footer" data-v-ac83a848><div data-v-ac83a848><a href="https://cloudlinux.com" data-v-ac83a848><img src="/assets/img/we-are-cloudlinux.783ed390.svg" alt="We are Cloudlinux" data-v-ac83a848></a></div> <div data-v-ac83a848>2018. CloudLinux Inc</div> <div data-v-ac83a848><div data-v-ac83a848><a href="https://cloudlinux.zendesk.com/hc/sections/115001344329-How-do-I" target="_blank" data-v-ac83a848>How to</a></div><div data-v-ac83a848><a href="https://imunify360.com/getting-started" target="_blank" data-v-ac83a848>Getting started</a></div><div data-v-ac83a848><a href="https://cloudlinux.zendesk.com/hc/en-us/requests/new" target="_blank" data-v-ac83a848>Contact support</a></div><div data-v-ac83a848><a href="https://www.imunify360.com/blog" target="_blank" data-v-ac83a848>Blog</a></div></div> <div class="social" data-v-ac83a848><span data-v-ac83a848>Stay in touch</span> <a href="https://www.facebook.com/imunify360/" target="_blank" data-v-ac83a848><img src="/fb.svg" data-v-ac83a848></a><a href="https://twitter.com/imunify360/" target="_blank" data-v-ac83a848><img src="/tw.svg" data-v-ac83a848></a><a href="https://linkedin.com/company/cloudlinux" target="_blank" data-v-ac83a848><img src="/in.svg" data-v-ac83a848></a><a href="https://www.youtube.com/channel/UCcW6dDJjcy41c7Hl_5LdLZQ" target="_blank" data-v-ac83a848><img src="/ytube.svg" data-v-ac83a848></a></div></div> <!----></div></div>
    <script src="/assets/js/app.82cee872.js" defer></script><script src="/assets/js/5.3d4a6f6f.js" defer></script>
  </body>
</html>
